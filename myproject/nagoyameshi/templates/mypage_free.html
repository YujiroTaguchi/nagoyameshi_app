{% extends 'base.html' %}

{% block title %}マイページ{% endblock %}

{% block content %}
<div class="container mt-4">
    <h2>マイページ</h2>
    <div class="list-group">
        <!-- 会員情報編集ボタン -->
        <a href="{% url 'edit_profile' %}" class="list-group-item list-group-item-action">会員情報編集</a>
        <!-- 有料会員登録ボタン -->
        <form id="checkout-form" action="{% url 'create-checkout-session' %}" method="POST" class="list-group-item">
            {% csrf_token %}
            <button type="button" id="checkout-button" class="btn btn-primary">有料会員登録</button>
        </form>
        <!-- ログアウトボタン -->
        <a href="{% url 'logout' %}" class="list-group-item list-group-item-action">ログアウト</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM fully loaded and parsed');
    var stripe = Stripe('{{ stripe_public_key }}');
    console.log('Stripe initialized');

    var checkoutButton = document.getElementById('checkout-button');
    if (checkoutButton) {
        console.log('Checkout button found');
    } else {
        console.error('Checkout button not found');
    }

    checkoutButton.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Checkout button clicked');
        fetch('{% url "create-checkout-session" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(function(response) {
            console.log('Response received', response);
            return response.json();
        })
        .then(function(session) {
            console.log('Session received', session);
            return stripe.redirectToCheckout({ sessionId: session.id });
        })
        .then(function(result) {
            if (result.error) {
                console.error('Stripe error', result.error.message);
                alert(result.error.message);
            }
        })
        .catch(function(error) {
            console.error('Error:', error);
        });
    });
});
</script>
{% endblock %}
